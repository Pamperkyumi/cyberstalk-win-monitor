<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>CyberStalk Â· å®æ—¶çŠ¶æ€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top, #7dd3fc 0, #0f172a 55%, #020617 100%);
      --card-bg: rgba(15, 23, 42, 0.72);
      --card-border: rgba(148, 163, 184, 0.35);
      --text-main: #e5e7eb;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --danger-soft: rgba(248, 113, 113, 0.14);
      --warn-soft: rgba(234, 179, 8, 0.14);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background-image: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 24px 16px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
      border-radius: 28px;
      padding: 1px;
      background: linear-gradient(135deg, rgba(248, 250, 252, 0.45), rgba(148, 163, 184, 0.2));
      box-shadow:
        0 40px 120px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(26px);
    }

    .inner {
      background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.08), rgba(15, 23, 42, 0.95));
      border-radius: 27px;
      padding: 20px 20px 24px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.7);
    }

    .subtitle {
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .status-chip-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      justify-content: flex-end;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.2);
    }

    .status-chip {
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 16px;
    }

    .layout-main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .layout-side {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 20px;
      border: 1px solid var(--card-border);
      box-shadow:
        0 20px 45px rgba(15, 23, 42, 0.65),
        0 0 0 1px rgba(15, 23, 42, 0.8);
      padding: 14px 16px 16px;
      backdrop-filter: blur(22px);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.15), transparent 55%);
      opacity: 0.75;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      width: 20px;
      height: 20px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-badge, .error-badge, .warn-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
      white-space: nowrap;
      gap: 4px;
    }

    .status-badge {
      background: var(--accent-soft);
      color: #7dd3fc;
      border-color: rgba(56, 189, 248, 0.65);
    }
    .error-badge {
      background: var(--danger-soft);
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.7);
    }
    .warn-badge {
      background: var(--warn-soft);
      color: #fde68a;
      border-color: rgba(234, 179, 8, 0.7);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
    }

    .hr-value-row {
      display: flex;
      align-items: baseline;
      gap: 4px;
      margin-top: 4px;
    }

    .hr-value {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .hr-unit {
      font-size: 13px;
      color: var(--text-muted);
    }

    .timestamp {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .small {
      font-size: 11px;
    }

    #hr-chart {
      margin-top: 10px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 13px;
    }

    .active-app {
      font-size: 18px;
      font-weight: 600;
      margin-top: 2px;
      margin-bottom: 4px;
    }

    .window-title {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
    }

    th, td {
      padding: 6px 4px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 64, 175, 0.45);
    }

    th {
      color: var(--text-muted);
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tr:hover td {
      background: rgba(15, 23, 42, 0.7);
    }

    .pid-col {
      width: 60px;
    }

    .proc-col {
      width: 170px;
    }

    .footer {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.85;
    }

    .footer a {
      color: #7dd3fc;
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    @media (max-width: 900px) {
      .shell {
        border-radius: 0;
        box-shadow: none;
        max-width: 100%;
      }
      .inner {
        border-radius: 0;
        padding: 16px 10px 18px;
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="shell">
  <div class="inner">
    <div class="top-bar">
      <div class="title-block">
        <h1>
          <span>CyberStalk</span>
          <span class="title-pill">Live Status</span>
        </h1>
        <div class="subtitle">
          å®æ—¶å±•ç¤ºæˆ‘çš„ä¸ªäººæƒ…å†µ
        </div>
      </div>
      <div class="status-chip-row">
        <div class="status-dot"></div>
        <div class="status-chip">Connected Â· cyberstalk.online</div>
      </div>
    </div>

    <div class="layout">
      <!-- å·¦ä¾§ï¼šå¿ƒç‡ & æ´»åŠ¨çª—å£ -->
      <div class="layout-main">
        <!-- å¿ƒç‡å¡ç‰‡ -->
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">â¤ï¸</span>
                  <span>å½“å‰å¿ƒç‡</span>
                </div>
                <div class="card-subtitle small">
                  æ¥è‡ª Apple Watch
                </div>
              </div>
              <span id="hr-status-badge" class="status-badge">
                <span class="badge-dot"></span> ç­‰å¾…æ•°æ®
              </span>
            </div>

            <div class="hr-value-row">
              <div class="hr-value" id="hr-value">--</div>
              <div class="hr-unit">bpm</div>
            </div>
            <div id="hr-time" class="timestamp"></div>
            <div id="hr-hint" class="muted small" style="margin-top: 4px;">
              å¿ƒç‡æ¯éš”ä¸€æ®µæ—¶é—´æ›´æ–°ï¼Œè‹¥é•¿æ—¶é—´æœªæ›´æ–°å¯èƒ½æˆ‘å·²ç»æ­»äº†
            </div>
            <canvas id="hr-chart" height="150"></canvas>
          </div>
        </div>

        <!-- å½“å‰æ´»åŠ¨çª—å£ -->
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">ğŸ’»</span>
                  <span>å½“å‰æ´»åŠ¨çª—å£</span>
                </div>
                <div class="card-subtitle small">
                  æ¥è‡ª Windows
                </div>
              </div>
              <span id="status-badge" class="status-badge">
                <span class="badge-dot"></span> ç­‰å¾…æ•°æ®
              </span>
            </div>

            <div id="active-app" class="active-app">æš‚æ— æ•°æ®</div>
            <div id="active-title" class="window-title"></div>
            <div id="timestamp" class="timestamp"></div>
          </div>
        </div>
          <div class="card">
    <div class="card-inner">
    <div class="card-header">
      <div>
        <div class="card-title">
          <span class="icon">ğŸ“±</span>
          <span>æˆ‘çš„æ‰‹æœºä½¿ç”¨æƒ…å†µ</span>
        </div>
        <div class="card-subtitle small">æ¥è‡ª iPhone </div>
      </div>
      <span id="phone-badge" class="status-badge">
        <span class="badge-dot"></span> ç­‰å¾…æ•°æ®
      </span>
    </div>
    <div class="active-app"> å‹å·: Iphone 15</div>
    <div class="active-app">ç½‘ç»œè¿æ¥: ä¸­å›½ç”µä¿¡5G</div>
    <div class="active-app" id="phone-lock">é”å®šçŠ¶æ€ï¼š--</div>
    <div class="active-app" id="phone-battery">ç”µæ± ç”µé‡ï¼š--%</div>
    <div class="active-app" id="phone-app">å½“å‰åº”ç”¨ï¼š--</div>

    <div id="phone-time" class="timestamp"></div>
  </div>
</div>
      </div>
      <!-- å³ä¾§ï¼šæ‰“å¼€çš„è½¯ä»¶åˆ—è¡¨ -->
      <div class="layout-side">
        <div class="card">
          <div class="card-inner">
            <div class="card-header">
              <div>
                <div class="card-title">
                  <span class="icon">ğŸ§©</span>
                  <span>å½“å‰æ‰“å¼€çš„è½¯ä»¶</span>
                </div>
                <div class="card-subtitle small">
                  ä»…ç»Ÿè®¡æœ‰å¯è§çª—å£çš„åº”ç”¨ Â· æ¯ 30 ç§’åˆ·æ–°ã€‚
                </div>
              </div>
            </div>

            <table>
              <thead>
              <tr>
                <th class="pid-col">PID</th>
                <th class="proc-col">è¿›ç¨‹</th>
                <th>çª—å£æ ‡é¢˜</th>
              </tr>
              </thead>
              <tbody id="apps-body">
              <tr><td colspan="3" class="muted">æš‚æ— æ•°æ®</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>æ•°æ®æºï¼šç”µè„‘ & Apple Watch & Iphone</div>
      <div><a href="https://cyberstalk.online" target="_blank">cyberstalk.online</a></div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const STALE_MINUTES = 10;      // ç¨‹åºçŠ¶æ€è¶…æ—¶
  const HR_STALE_MINUTES = 10;   // å¿ƒç‡è¶…æ—¶

  function utcToLocalString(utcStr) {
    if (!utcStr) return "";
    const d = new Date(utcStr.replace(" ", "T") + "Z");
    if (isNaN(d.getTime())) {
      return utcStr;
    }
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    const ss = String(d.getSeconds()).padStart(2, "0");
    return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
  }

  function formatElapsed(minutes) {
    const totalMinutes = Math.max(0, Math.round(minutes));
    const hours = Math.floor(totalMinutes / 60);
    const mins = totalMinutes % 60;

    if (hours === 0 && mins === 0) return "åˆšåˆš";
    if (hours === 0) return `${mins} åˆ†é’Ÿ`;
    if (mins === 0) return `${hours} å°æ—¶`;
    return `${hours} å°æ—¶ ${mins} åˆ†é’Ÿ`;
  }

  // ---------------- å¿ƒç‡ç›¸å…³ ----------------
  let hrChart = null;

  async function fetchHeartRate() {
    const badge = document.getElementById("hr-status-badge");
    const valueEl = document.getElementById("hr-value");
    const timeEl = document.getElementById("hr-time");

    try {
      const res = await fetch("/api/latest_heartrate");
      const data = await res.json();
      console.log("latest heartrate:", data);

      if (data.status === "no data") {
        badge.textContent = "ç­‰å¾…æ•°æ®";
        badge.className = "status-badge";
        valueEl.innerText = "--";
        timeEl.innerText = "";
        return;
      }

      const tsText = data.timestamp;
      const rate = data.rate;

      let isStale = false;
      let elapsedMinutes = 0;
      if (tsText) {
        const parsedUtc = new Date(tsText.replace(" ", "T") + "Z");
        if (!isNaN(parsedUtc.getTime())) {
          const now = new Date();
          elapsedMinutes = (now - parsedUtc) / 60000;
          if (elapsedMinutes >= HR_STALE_MINUTES) {
            isStale = true;
          }
        }
      }

      const localTimeStr = utcToLocalString(tsText);

      valueEl.innerText = rate;
      if (isStale) {
        badge.textContent = "å¿ƒç‡æ•°æ®å·²è¿‡æœŸ";
        badge.className = "warn-badge";
        const elapsedText = formatElapsed(elapsedMinutes);
        timeEl.innerText =
          `è·ç¦»ä¸Šæ¬¡å¿ƒç‡ä¸ŠæŠ¥å·²ç»è¿‡å»çº¦ ${elapsedText}ï¼ˆæœ€åå¿ƒç‡æ—¶é—´ï¼š${localTimeStr}ï¼‰`;
      } else {
        badge.textContent = "æ­£å¸¸";
        badge.className = "status-badge";
        timeEl.innerText = `æœ€è¿‘ä¸€æ¬¡å¿ƒç‡æ—¶é—´ï¼š${localTimeStr}`;
      }

    } catch (e) {
      console.error("fetchHeartRate error:", e);
      badge.textContent = "é”™è¯¯";
      badge.className = "error-badge";
      valueEl.innerText = "--";
      timeEl.innerText = "æ— æ³•è·å–å¿ƒç‡æ•°æ®";
    }
  }

  async function fetchHeartRateHistory() {
    const canvas = document.getElementById("hr-chart");
    const ctx = canvas.getContext("2d");

    try {
      const res = await fetch("/api/heartrate_history");
      const data = await res.json();
      console.log("heartrate history:", data);

      const points = data.points || [];
      if (!points.length) {
        return;
      }

      const labels = points.map(p => {
        const d = new Date(p.timestamp.replace(" ", "T") + "Z");
        if (isNaN(d.getTime())) return p.timestamp;
        return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      });

      const values = points.map(p => p.rate);

      if (!hrChart) {
        hrChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "å¿ƒç‡ (bpm)",
              data: values,
              tension: 0.35,
              fill: false
            }]
          },
          options: {
            plugins: {
              legend: {
                labels: { color: "#e5e7eb" }
              }
            },
            scales: {
              x: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(30,64,175,0.5)" }
              },
              y: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(30,64,175,0.5)" }
              }
            }
          }
        });
      } else {
        hrChart.data.labels = labels;
        hrChart.data.datasets[0].data = values;
        hrChart.update();
      }

    } catch (e) {
      console.error("fetchHeartRateHistory error:", e);
    }
  }

  // ---------------- ç¨‹åºçŠ¶æ€ç›¸å…³ ----------------
  async function fetchStatus() {
    const statusBadge = document.getElementById("status-badge");
    const activeAppEl = document.getElementById("active-app");
    const activeTitleEl = document.getElementById("active-title");
    const timestampEl = document.getElementById("timestamp");
    const appsBody = document.getElementById("apps-body");

    try {
      const res = await fetch("/api/current");
      const data = await res.json();

      console.log("data from /api/current:", data);

      if (data.status === "no data yet") {
        activeAppEl.innerText = "æš‚æ—¶è¿˜æ²¡æœ‰ä¸ŠæŠ¥æ•°æ®";
        activeTitleEl.innerText = "";
        timestampEl.innerText = "";
        appsBody.innerHTML =
          '<tr><td colspan="3" class="muted">ç­‰å¾…å®¢æˆ·ç«¯ä¸ŠæŠ¥...</td></tr>';
        statusBadge.textContent = "ç­‰å¾…ä¸ŠæŠ¥";
        statusBadge.className = "status-badge";
        return;
      }

      const tsText = data.timestamp || "";
      const active = data.active || {};
      const apps = data.apps || [];

      let isStale = false;
      let elapsedMinutes = 0;
      if (tsText) {
        const parsedUtc = new Date(tsText.replace(" ", "T") + "Z");
        if (!isNaN(parsedUtc.getTime())) {
          const now = new Date();
          elapsedMinutes = (now - parsedUtc) / 60000;
          if (elapsedMinutes >= STALE_MINUTES) {
            isStale = true;
          }
        }
      }

      const localTimeStr = tsText ? utcToLocalString(tsText) : "";

      if (isStale) {
        const elapsedText = formatElapsed(elapsedMinutes);

        activeAppEl.innerText = "å®¢æˆ·ç«¯å·²ç¦»çº¿";
        activeTitleEl.innerText = "";
        timestampEl.innerText =
          `è·ç¦»ä¸Šæ¬¡æ›´æ–°å·²ç»è¿‡å»çº¦ ${elapsedText}ï¼ˆæœ€åæ›´æ–°æ—¶é—´ï¼š${localTimeStr}ï¼‰`;

        statusBadge.textContent = "ç¦»çº¿";
        statusBadge.className = "error-badge";

        appsBody.innerHTML = `
          <tr>
            <td colspan="3" class="muted">
              å®¢æˆ·ç«¯å·²ç¦»çº¿ï¼Œæœ€è¿‘ä¸€æ¬¡ä¸ŠæŠ¥æ—¶é—´ï¼š${localTimeStr}
            </td>
          </tr>
          <tr>
            <td colspan="3" class="muted">
              è¯·æ£€æŸ¥æœ¬åœ°è„šæœ¬æ˜¯å¦ä»åœ¨è¿è¡Œã€‚
            </td>
          </tr>
        `;
        return;
      }

      // åœ¨çº¿
      activeAppEl.innerText = active.process_name || "æœªçŸ¥ç¨‹åº";
      activeTitleEl.innerText = active.window_title || "";
      timestampEl.innerText = localTimeStr
        ? ("æœ€åä¸ŠæŠ¥æ—¶é—´ï¼š" + localTimeStr)
        : "";

      statusBadge.textContent = "åœ¨çº¿";
      statusBadge.className = "status-badge";

      if (!apps.length) {
        appsBody.innerHTML =
          '<tr><td colspan="3" class="muted">å½“å‰æ²¡æœ‰æ£€æµ‹åˆ°æœ‰å¯è§çª—å£çš„åº”ç”¨</td></tr>';
        return;
      }

      appsBody.innerHTML = "";
      apps.forEach(app => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="pid-col">${app.pid ?? ""}</td>
          <td class="proc-col">${app.process_name ?? ""}</td>
          <td>${app.window_title ?? ""}</td>
        `;
        appsBody.appendChild(tr);
      });

    } catch (e) {
      console.error("fetchStatus error:", e);
      statusBadge.textContent = "é”™è¯¯";
      statusBadge.className = "error-badge";
      activeAppEl.innerText = "æ— æ³•è·å–æ•°æ®";
      activeTitleEl.innerText = "";
      timestampEl.innerText = "";
      appsBody.innerHTML =
        '<tr><td colspan="3" class="muted">è¯·æ±‚ /api/current å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æˆ–ç½‘ç»œ</td></tr>';
    }
  }

  // å®šæ—¶åˆ·æ–°
  fetchStatus();
  fetchHeartRate();
  fetchHeartRateHistory();
  setInterval(fetchStatus, 5000);
  setInterval(fetchHeartRate, 15000);
  setInterval(fetchHeartRateHistory, 60000);
</script>

</body>
</html>
